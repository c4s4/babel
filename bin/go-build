#!/bin/bash

set -e

# help page
usage() {
    cat << EOF
usage: go-build [-h] version
Build and install a given version of GO:
-h       Print this help page.
version  The version to build and install (such as "1.10.4").
EOF
}

# URL to download the archive
ARCHIVE_ROOT=https://go.dev/dl/

# read command line arguments
while getopts â€œh:â€ OPTION
do
     case ${OPTION} in
         h)
             usage
             exit
             ;;
         ?)
             usage
             exit 1
             ;;
     esac
done

# remove the switches we parsed above
shift `expr ${OPTIND} - 1`

# get version on command line
if [[ $# != 1 ]]
then
    echo "Missing version!"
    usage
    exit 1
else
    VERSION=$1
fi

# check that install directory doesn't exist
if [[ -z "${APP_DIR}" ]]
then
    APP_DIR="/opt"
fi
INSTALL_DIR=${APP_DIR}/go/${VERSION}

if [ -d ${INSTALL_DIR} ]
then
    echo "Destination directory '${INSTALL_DIR}' already exists, aborting!"
    exit 1
fi

# download source archive
ARCHIVE_FILE=go${VERSION}.src.tar.gz
ARCHIVE_URL=${ARCHIVE_ROOT}/${ARCHIVE_FILE}

# download, expand archive and move to installation directory
cd /tmp
wget ${ARCHIVE_URL}
tar xvf ${ARCHIVE_FILE}
rm ${ARCHIVE_FILE}

# move directory to destination and build from sources
if [ -w "${APP_DIR}" ]
then
    mv go ${INSTALL_DIR}
    cd ${INSTALL_DIR}/src
    bash all.bash
else
    sudo mv go ${INSTALL_DIR}
    cd ${INSTALL_DIR}/src
    bash all.bash
    sudo chown -R root: ${INSTALL_DIR}
fi
